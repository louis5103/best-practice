import {
  Entity,
  PrimaryGeneratedColumn,
  Column,
  CreateDateColumn,
  UpdateDateColumn,
  Index
} from 'typeorm';
import { ProductCategory, ProductStatus } from '../../common/types';

/**
 * Product ì—”í‹°í‹° - ìƒí’ˆ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì˜ êµ¬ì¡°ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
 * 
 * âœ¨ ìµœì‹  ê°œì„ ì‚¬í•­:
 * - ê³µí†µ íƒ€ì… ì‹œìŠ¤í…œ ë„ì…ìœ¼ë¡œ DTOì™€ 100% ì¼ì¹˜í•˜ëŠ” í•„ë“œ êµ¬ì¡°
 * - ProductCategory, ProductStatus enumì„ ê³µí†µ íƒ€ì…ì—ì„œ import
 * - íƒ€ì… ì•ˆì „ì„±ê³¼ ì½”ë“œ ì¼ê´€ì„± ëŒ€í­ í–¥ìƒ
 * - ì¤‘ë³µëœ enum ì •ì˜ ì œê±°ë¡œ ë‹¨ì¼ ì§„ì‹¤ ì›ì²œ(Single Source of Truth) êµ¬í˜„
 * 
 * ì´ ì—”í‹°í‹°ëŠ” ì‹¤ì œ ì‡¼í•‘ëª°ì—ì„œ í•„ìš”í•œ ëª¨ë“  ìƒí’ˆ ì •ë³´ë¥¼ í¬í•¨í•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
 * CreateProductDtoì™€ ì™„ì „íˆ ì¼ì¹˜í•˜ëŠ” í•„ë“œë“¤ì„ ê°€ì§€ê³  ìˆì–´, ë°ì´í„° ì¼ê´€ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.
 * 
 * ì£¼ìš” íŠ¹ì§•:
 * 1. ğŸ¯ DTOì™€ ì—”í‹°í‹° ê°„ì˜ ì™„ë²½í•œ í•„ë“œ ì¼ì¹˜ì„±
 * 2. ğŸ”§ ê³µí†µ íƒ€ì… ì‹œìŠ¤í…œì„ í†µí•œ ì¤‘ë³µ ì œê±°
 * 3. ğŸ“¦ ë‹¤ì¤‘ ì´ë¯¸ì§€ ì§€ì› (imageUrls ë°°ì—´)
 * 4. ğŸ·ï¸ íƒœê·¸ ì‹œìŠ¤í…œìœ¼ë¡œ ê²€ìƒ‰ ë° ë¶„ë¥˜ ê¸°ëŠ¥ í–¥ìƒ
 * 5. ğŸ’° í• ì¸ê°€ê²©ê³¼ ì •ê°€ë¥¼ ë¶„ë¦¬í•œ ìœ ì—°í•œ ê°€ê²© ì²´ê³„
 * 6. ğŸ“Š ë¸Œëœë“œ, ë¬´ê²Œ, ì¹˜ìˆ˜ ë“± ì‹¤ë¬´ì—ì„œ í•„ìš”í•œ ìƒì„¸ ì •ë³´
 * 7. âš¡ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìœ„í•œ ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œë“¤
 */
@Entity('products')
@Index(['category']) // ì¹´í…Œê³ ë¦¬ë³„ ê²€ìƒ‰ ì„±ëŠ¥ í–¥ìƒ
@Index(['status']) // ìƒí’ˆ ìƒíƒœë³„ ì¡°íšŒ ì„±ëŠ¥ í–¥ìƒ 
@Index(['brand']) // ë¸Œëœë“œë³„ ê²€ìƒ‰ ì„±ëŠ¥ í–¥ìƒ
@Index(['tags']) // íƒœê·¸ ê²€ìƒ‰ ì„±ëŠ¥ í–¥ìƒ (GIN ì¸ë±ìŠ¤ ê¶Œì¥)
export class Product {
  /**
   * ìƒí’ˆ ê³ ìœ  ì‹ë³„ìì…ë‹ˆë‹¤.
   */
  @PrimaryGeneratedColumn()
  id!: number;

  /**
   * ìƒí’ˆëª…ì…ë‹ˆë‹¤.
   * 
   * DTOì™€ ë™ì¼í•œ ê¸¸ì´ ì œí•œì„ ì ìš©í•˜ì—¬ ì¼ê´€ì„±ì„ ìœ ì§€í•©ë‹ˆë‹¤.
   */
  @Column({ 
    length: 200,
    comment: 'ìƒí’ˆëª…'
  })
  name!: string;

  /**
   * ìƒí’ˆ ìƒì„¸ ì„¤ëª…ì…ë‹ˆë‹¤.
   * 
   * text íƒ€ì…ì„ ì‚¬ìš©í•˜ì—¬ ê¸´ ì„¤ëª…ë„ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   */
  @Column({ 
    type: 'text',
    nullable: true,
    comment: 'ìƒí’ˆ ìƒì„¸ ì„¤ëª…'
  })
  description?: string;

  /**
   * ìƒí’ˆ ì •ê°€ì…ë‹ˆë‹¤.
   * 
   * decimal íƒ€ì…ì„ ì‚¬ìš©í•˜ì—¬ ì •í™•í•œ ê¸ˆì•¡ ê³„ì‚°ì„ ë³´ì¥í•©ë‹ˆë‹¤.
   * precision 10, scale 2ëŠ” ìµœëŒ€ 99,999,999.99ê¹Œì§€ ì €ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.
   */
  @Column({ 
    type: 'decimal',
    precision: 10,
    scale: 2,
    comment: 'ìƒí’ˆ ì •ê°€'
  })
  price!: number;

  /**
   * í• ì¸ ê°€ê²©ì…ë‹ˆë‹¤.
   * 
   * í• ì¸ì´ ìˆëŠ” ìƒí’ˆì˜ ê²½ìš°ì—ë§Œ ê°’ì´ ì„¤ì •ë˜ë©°, nullì´ë©´ í• ì¸ì´ ì—†ëŠ” ê²ƒì…ë‹ˆë‹¤.
   * ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ì´ ê°’ì´ ì •ê°€ë³´ë‹¤ ë‚®ì€ì§€ ê²€ì¦í•´ì•¼ í•©ë‹ˆë‹¤.
   */
  @Column({ 
    type: 'decimal',
    precision: 10,
    scale: 2,
    nullable: true,
    comment: 'í• ì¸ ê°€ê²© (ì •ê°€ë³´ë‹¤ ë‚®ì•„ì•¼ í•¨)'
  })
  discountPrice?: number;

  /**
   * ìƒí’ˆ ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤.
   * 
   * enumì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ì¼ê´€ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.
   * PostgreSQLì—ì„œëŠ” ì‹¤ì œ enum íƒ€ì…ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
   */
  @Column({
    type: 'enum',
    enum: ProductCategory,
    comment: 'ìƒí’ˆ ì¹´í…Œê³ ë¦¬'
  })
  category!: ProductCategory;

  /**
   * ìƒí’ˆ ìƒíƒœì…ë‹ˆë‹¤.
   * 
   * ê¸°ì¡´ì˜ ë‹¨ìˆœí•œ isActive boolean ëŒ€ì‹  ë” ì„¸ë°€í•œ ìƒíƒœ ê´€ë¦¬ë¥¼ ìœ„í•´ enumì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
   * ì´ë ‡ê²Œ í•˜ë©´ 'í’ˆì ˆ', 'ë‹¨ì¢…', 'ì„ì‹œì¤‘ë‹¨' ë“±ì˜ ìƒíƒœë¥¼ êµ¬ë¶„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   */
  @Column({
    type: 'enum',
    enum: ProductStatus,
    default: ProductStatus.DRAFT,
    comment: 'ìƒí’ˆ ìƒíƒœ'
  })
  status!: ProductStatus;

  /**
   * ì¬ê³  ìˆ˜ëŸ‰ì…ë‹ˆë‹¤.
   * 
   * ì¬ê³ ê°€ 0ì´ ë˜ë©´ ìë™ìœ¼ë¡œ statusë¥¼ OUT_OF_STOCKìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ë¡œì§ì„
   * ì„œë¹„ìŠ¤ ë ˆì´ì–´ì—ì„œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   */
  @Column({ 
    default: 0,
    comment: 'ì¬ê³  ìˆ˜ëŸ‰'
  })
  stock!: number;

  /**
   * ìƒí’ˆ ì´ë¯¸ì§€ URL ë°°ì—´ì…ë‹ˆë‹¤.
   * 
   * í˜„ëŒ€ ì‡¼í•‘ëª°ì—ì„œëŠ” ìƒí’ˆì„ ì—¬ëŸ¬ ê°ë„ì—ì„œ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë¯€ë¡œ
   * ë‹¨ì¼ ì´ë¯¸ì§€ê°€ ì•„ë‹Œ ë°°ì—´ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
   * 
   * PostgreSQLì˜ ê²½ìš° array íƒ€ì…ì„ ì§€ì›í•˜ì§€ë§Œ, í˜¸í™˜ì„±ì„ ìœ„í•´ 
   * simple-arrayë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ë¡œ ì €ì¥)
   */
  @Column({
    type: 'simple-array',
    nullable: true,
    comment: 'ìƒí’ˆ ì´ë¯¸ì§€ URL ë°°ì—´'
  })
  imageUrls?: string[];

  /**
   * ìƒí’ˆ íƒœê·¸ ë°°ì—´ì…ë‹ˆë‹¤.
   * 
   * ê²€ìƒ‰ ìµœì í™”, ì¶”ì²œ ì‹œìŠ¤í…œ, ê´€ë ¨ ìƒí’ˆ ì œì•ˆ ë“±ì— í™œìš©ë©ë‹ˆë‹¤.
   * íƒœê·¸ëŠ” ì†Œë¬¸ìë¡œ ì •ê·œí™”ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.
   */
  @Column({
    type: 'simple-array',
    nullable: true,
    comment: 'ìƒí’ˆ íƒœê·¸ (ê²€ìƒ‰ ë° ë¶„ë¥˜ìš©)'
  })
  tags?: string[];

  /**
   * ìƒí’ˆ ë¸Œëœë“œì…ë‹ˆë‹¤.
   * 
   * ë¸Œëœë“œë³„ ê²€ìƒ‰ì´ë‚˜ í•„í„°ë§ì„ ìœ„í•´ ë³„ë„ í•„ë“œë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.
   * ë¸Œëœë“œ ì •ë³´ëŠ” ê³ ê°ì˜ êµ¬ë§¤ ê²°ì •ì— ì¤‘ìš”í•œ ìš”ì†Œì…ë‹ˆë‹¤.
   */
  @Column({ 
    nullable: true,
    length: 100,
    comment: 'ìƒí’ˆ ë¸Œëœë“œ'
  })
  brand?: string;

  /**
   * ìƒí’ˆ ë¬´ê²Œì…ë‹ˆë‹¤ (ê·¸ë¨ ë‹¨ìœ„).
   * 
   * ë°°ì†¡ë¹„ ê³„ì‚°ì´ë‚˜ ë¬¼ë¥˜ ê´€ë¦¬ì— í•„ìš”í•œ ì •ë³´ì…ë‹ˆë‹¤.
   * ë””ì§€í„¸ ìƒí’ˆì´ë‚˜ ì„œë¹„ìŠ¤ì˜ ê²½ìš°ì—ëŠ” nullì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   */
  @Column({ 
    nullable: true,
    comment: 'ìƒí’ˆ ë¬´ê²Œ (ê·¸ë¨ ë‹¨ìœ„)'
  })
  weight?: number;

  /**
   * ìƒí’ˆ ì¹˜ìˆ˜ì…ë‹ˆë‹¤ (ê°€ë¡œ x ì„¸ë¡œ x ë†’ì´, cm ë‹¨ìœ„).
   * 
   * ë°°ì†¡ ìƒì í¬ê¸° ê³„ì‚°ì´ë‚˜ ì§„ì—´ ê³„íšì— í™œìš©ë©ë‹ˆë‹¤.
   * "14.7 x 7.1 x 0.8" í˜•íƒœì˜ ë¬¸ìì—´ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
   */
  @Column({ 
    nullable: true,
    length: 50,
    comment: 'ìƒí’ˆ ì¹˜ìˆ˜ (ê°€ë¡œ x ì„¸ë¡œ x ë†’ì´, cm ë‹¨ìœ„)'
  })
  dimensions?: string;

  /**
   * ìƒí’ˆ ë“±ë¡ ì‹œê°„ì…ë‹ˆë‹¤.
   * 
   * ìë™ìœ¼ë¡œ í˜„ì¬ ì‹œê°„ì´ ì„¤ì •ë˜ë©°, ìƒí’ˆ ë“±ë¡ ìˆœì„œë¥¼ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   */
  @CreateDateColumn({ 
    name: 'created_at',
    comment: 'ìƒí’ˆ ë“±ë¡ ì‹œê°„'
  })
  createdAt!: Date;

  /**
   * ìƒí’ˆ ì •ë³´ ìˆ˜ì • ì‹œê°„ì…ë‹ˆë‹¤.
   * 
   * ìƒí’ˆ ì •ë³´ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.
   * ì¬ê³  ë³€ê²½, ê°€ê²© ë³€ê²½ ë“±ì˜ ì´ë ¥ì„ ì¶”ì í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   */
  @UpdateDateColumn({ 
    name: 'updated_at',
    comment: 'ìƒí’ˆ ì •ë³´ ìˆ˜ì • ì‹œê°„'
  })
  updatedAt!: Date;

  /**
   * í• ì¸ìœ¨ì„ ê³„ì‚°í•˜ëŠ” ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œì…ë‹ˆë‹¤.
   * 
   * ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì—”í‹°í‹°ì— í¬í•¨ì‹œì¼œ ì¬ì‚¬ìš©ì„±ì„ ë†’ì…ë‹ˆë‹¤.
   * í• ì¸ê°€ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ í• ì¸ìœ¨ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
   * 
   * @returns í• ì¸ìœ¨ (í¼ì„¼íŠ¸), í• ì¸ì´ ì—†ìœ¼ë©´ 0
   */
  getDiscountRate(): number {
    if (!this.discountPrice || this.discountPrice >= this.price) {
      return 0;
    }
    
    const discount = this.price - this.discountPrice;
    return Math.round((discount / this.price) * 100);
  }

  /**
   * ì‹¤ì œ íŒë§¤ ê°€ê²©ì„ ë°˜í™˜í•˜ëŠ” ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œì…ë‹ˆë‹¤.
   * 
   * í• ì¸ê°€ê°€ ìˆìœ¼ë©´ í• ì¸ê°€ë¥¼, ì—†ìœ¼ë©´ ì •ê°€ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
   * í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ê°€ê²© í‘œì‹œí•  ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.
   * 
   * @returns ì‹¤ì œ íŒë§¤ ê°€ê²©
   */
  getSellingPrice(): number {
    return this.discountPrice && this.discountPrice < this.price 
      ? this.discountPrice 
      : this.price;
  }

  /**
   * ìƒí’ˆì´ êµ¬ë§¤ ê°€ëŠ¥í•œ ìƒíƒœì¸ì§€ í™•ì¸í•˜ëŠ” ë©”ì„œë“œì…ë‹ˆë‹¤.
   * 
   * ìƒíƒœê°€ ACTIVEì´ê³  ì¬ê³ ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ êµ¬ë§¤ ê°€ëŠ¥í•©ë‹ˆë‹¤.
   * ì¥ë°”êµ¬ë‹ˆë‚˜ ì£¼ë¬¸ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   * 
   * @returns êµ¬ë§¤ ê°€ëŠ¥ ì—¬ë¶€
   */
  isAvailableForPurchase(): boolean {
    return this.status === ProductStatus.ACTIVE && this.stock > 0;
  }

  /**
   * ìƒí’ˆì˜ ëŒ€í‘œ ì´ë¯¸ì§€ URLì„ ë°˜í™˜í•©ë‹ˆë‹¤.
   * 
   * ì´ë¯¸ì§€ ë°°ì—´ì—ì„œ ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë¥¼ ëŒ€í‘œ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
   * ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ì´ë¯¸ì§€ URLì„ ë°˜í™˜í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
   * 
   * @returns ëŒ€í‘œ ì´ë¯¸ì§€ URL ë˜ëŠ” null
   */
  getMainImageUrl(): string | null {
    return this.imageUrls && this.imageUrls.length > 0 
      ? this.imageUrls[0] 
      : null;
  }
}
